const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
const TMDB_API_KEY = process.env.TMDB_API_KEY;

if (!TMDB_API_KEY) {
  console.warn('TMDB_API_KEY is not defined in environment variables');
}

export interface MediaItem {
  id: number;
  title?: string; // Movies have title
  name?: string;  // TV shows have name
  overview: string;
  poster_path: string | null;
  backdrop_path: string | null;
  media_type: 'movie' | 'tv' | 'person';
  vote_average: number;
  release_date?: string; // Movies
  first_air_date?: string; // TV
}

export interface Movie extends MediaItem {
  media_type: 'movie';
  title: string;
  original_title: string;
  release_date: string;
  video: boolean;
  adult: boolean;
  genre_ids: number[];
  vote_count: number;
}

export interface TVShow extends MediaItem {
  media_type: 'tv';
  name: string;
  original_name: string;
  first_air_date: string;
  origin_country: string[];
  genre_ids: number[];
  vote_count: number;
  seasons?: Season[]; // TMDB API returns seasons when calling /tv/{id} endpoint
}

export interface Episode {
  id: number;
  name: string;
  overview: string;
  vote_average: number;
  vote_count: number;
  air_date: string;
  episode_number: number;
  season_number: number;
  still_path: string | null;
  runtime?: number;
}

export interface Season {
  id: number;
  name: string;
  overview: string;
  poster_path: string | null;
  season_number: number;
  air_date: string;
  episodes?: Episode[];
  vote_average?: number;
}

export interface TMDBResponse<T> {
  page: number;
  results: T[];
  total_pages: number;
  total_results: number;
}

async function fetchTMDB<T>(endpoint: string, params: Record<string, string> = {}): Promise<T> {
  if (!TMDB_API_KEY) {
    throw new Error('TMDB_API_KEY is missing');
  }

  const searchParams = new URLSearchParams({
    api_key: TMDB_API_KEY,
    ...params,
  });

  const url = `${TMDB_BASE_URL}${endpoint}?${searchParams.toString()}`;

  try {
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`TMDB API Error: ${response.status} ${response.statusText}`);
    }

    return await response.json();
  } catch (error) {
    console.error(`Failed to fetch from TMDB (${endpoint}):`, error);
    throw error;
  }
}

export const tmdb = {
  getTrending: async (type: 'movie' | 'tv' | 'all' = 'all', timeWindow: 'day' | 'week' = 'day') => {
    return fetchTMDB<TMDBResponse<MediaItem>>(`/trending/${type}/${timeWindow}`);
  },

  searchMulti: async (query: string) => {
    return fetchTMDB<TMDBResponse<MediaItem>>('/search/multi', { query });
  },

  getDetails: async <T extends MediaItem>(type: 'movie' | 'tv', id: number) => {
    return fetchTMDB<T>(`/${type}/${id}`);
  },

  getSeasonDetails: async (tvId: number, seasonNumber: number) => {
    return fetchTMDB<Season>(`/tv/${tvId}/season/${seasonNumber}`);
  }
};
